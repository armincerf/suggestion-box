<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agile 3000 turbo pro max™️</title>
  <style id="user-selection-styles">
    /* Initial Base Styles (Apply before JS potentially hides things) */
    :root {
      --primary-color: #4338ca;
      --primary-hover-color: #3730a3;
      --text-color: #333;
      --bg-color: #f8f9fa;
      --card-bg-color: #fff;
      --error-color: #dc2626;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --border-color: #e5e7eb;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --primary-color: #6366f1;
        --primary-hover-color: #818cf8;
        --text-color: #e5e7eb;
        --bg-color: #1f2937;
        --card-bg-color: #374151;
        --error-color: #ef4444;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --border-color: #4b5563;
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      width: 100%;
      overflow: hidden;
      /* Prevent scrollbars during loading */
      transition: background-color 0.3s ease, color 0.3s ease;
      margin: 0;
      padding: 0;
      opacity: 1;
      /* Start visible */
      transition: opacity 0.3s ease-out;
    }

    body.app-loading {
      opacity: 0;
      /* Fade out body when app loader takes over */
    }


    /* User Selection Screen Styles */
    #userSelection {
      display: none;
      /* Hidden by default */
      height: 100vh;
      width: 100%;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      position: fixed;
      /* Keep it fixed while body might fade */
      top: 0;
      left: 0;
      z-index: 10;
      /* Below main loader */
      background-color: var(--bg-color);
      /* Ensure it has a background */
    }

    #userSelection.visible {
      display: flex;
    }

    #userSelection * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    #userSelection .card {
      background-color: var(--card-bg-color);
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      width: 100%;
      max-width: 400px;
      padding: 1.5rem;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    #userSelection .card-title {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--text-color);
    }

    #userSelection .button-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    @media (max-width: 400px) {
      #userSelection .button-grid {
        grid-template-columns: 1fr;
      }
    }

    #userSelection .btn {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 0.375rem;
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.15s ease;
      width: 100%;
    }

    /* Apply user-specific button colors directly */
    #userSelection .btn.user-alex {
      background-color: #4C72B0;
    }

    #userSelection .btn.user-dan {
      background-color: #DD8452;
    }

    #userSelection .btn.user-adrian {
      background-color: #55A868;
    }

    #userSelection .btn.user-rhi {
      background-color: #C44E52;
    }

    #userSelection .btn.user-john {
      background-color: #8172B3;
    }

    #userSelection .btn.user-manny {
      background-color: #937860;
    }

    #userSelection .btn.user-stepan {
      background-color: #DA8BC3;
    }

    #userSelection .btn:hover {
      filter: brightness(1.1);
      /* Simple hover effect */
    }

    /* Main App Loading Indicator */
    #app-loading-indicator {
      /* display: none; */
      /* REMOVED - Visible by default */
      display: flex;
      /* ADDED - Make visible by default */
      position: fixed;
      inset: 0;
      background-color: var(--bg-color);
      /* Match body background */
      z-index: 100;
      /* Highest */
      align-items: center;
      justify-content: center;
    }

    #app-loading-indicator .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(0, 0, 0, 0.1);
      /* Use neutral color */
      border-radius: 50%;
      border-top-color: var(--primary-color);
      /* Use theme color */
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Hide root until app is ready */
    #root {
      display: none;
    }

    #root.visible {
      display: block;
    }
  </style>
</head>

<body class="app-loading">
  <div id="root"></div>

  <div id="userSelection" style="display: none;">
    <div class="card">
      <h2 class="card-title">Select User</h2>
      <div class="button-grid" id="userButtons">
        <button class="btn user-alex" onclick="selectUser('Alex', '#4C72B0')">Alex</button>
        <button class="btn user-dan" onclick="selectUser('Dan', '#DD8452')">Dan</button>
        <button class="btn user-adrian" onclick="selectUser('Adrian', '#55A868')">Adrian</button>
        <button class="btn user-rhi" onclick="selectUser('Rhi', '#C44E52')">Rhi</button>
        <button class="btn user-john" onclick="selectUser('John', '#8172B3')">John</button>
        <button class="btn user-manny" onclick="selectUser('Manny', '#937860')">Manny</button>
        <button class="btn user-stepan" onclick="selectUser('Stepan', '#DA8BC3')">Stepan</button>
      </div>
    </div>
  </div>

  <div id="app-loading-indicator">
    <div class="spinner"></div>
  </div>

  <script>
    const JWT_SECRET = "zero";
    const JWT_EXPIRY_DAYS = 30;
    const USER_ID_KEY = 'userId';
    const JWT_KEY = 'jwt';
    const COLOR_KEY = 'color';

    // --- Utility Functions ---

    async function createJWT(payload) {
      const header = { alg: "HS256", typ: "JWT" };
      const iat = Math.floor(Date.now() / 1000);
      const exp = iat + JWT_EXPIRY_DAYS * 24 * 60 * 60;
      const fullPayload = { ...payload, iat, exp };

      function base64UrlEncode(str) {
        return btoa(str)
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=+$/, "");
      }

      const encHeader = base64UrlEncode(JSON.stringify(header));
      const encPayload = base64UrlEncode(JSON.stringify(fullPayload));
      const unsignedToken = `${encHeader}.${encPayload}`;

      const key = await crypto.subtle.importKey(
        "raw", new TextEncoder().encode(JWT_SECRET),
        { name: "HMAC", hash: "SHA-256" }, false, ["sign"]
      );
      const signature = await crypto.subtle.sign(
        "HMAC", key, new TextEncoder().encode(unsignedToken)
      );
      const encSignature = base64UrlEncode(String.fromCharCode(...new Uint8Array(signature)));

      return `${unsignedToken}.${encSignature}`;
    }

    function showElement(id) {
      const el = document.getElementById(id);
      if (el) el.classList.add('visible');
    }

    function hideElement(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove('visible');
    }

    function loadScript(src, type = 'module') {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.type = type;
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.body.appendChild(script);
      });
    }

    // --- Core Logic ---

    async function initializeApp() {
      console.log("Initializing app...");
      try {
        const userId = localStorage.getItem(USER_ID_KEY);

        if (userId) {
          console.log(`Returning user found: ${userId}`);
          // Returning user flow
          // Loader is already visible, body is already fading out
          // showElement('app-loading-indicator'); // REMOVED
          // document.body.classList.add('app-loading'); // REMOVED

          const jwt = await createJWT({ sub: userId });
          const color = localStorage.getItem(COLOR_KEY) || '#3498db'; // Get stored color or default
          localStorage.setItem(JWT_KEY, jwt);
          // UserID and Color are already in localStorage

          console.log("JWT generated for returning user.");
          await startMainApp(); // Load main app

        } else {
          console.log("New user detected. Showing selection.");
          // New user flow
          hideElement('app-loading-indicator'); // ADDED - Hide the loader
          showElement('userSelection'); // Show selection screen
          document.body.classList.remove('app-loading'); // ADDED - Make body visible for selection
        }
      } catch (error) {
        console.error("App initialization error:", error);
        // Optionally display an error message to the user here
      }
    }

    async function selectUser(userId, color) {
      console.log(`User selected: ${userId}, Color: ${color}`);
      try {
        hideElement('userSelection'); // Hide selection screen
        showElement('app-loading-indicator'); // Show loader
        document.body.classList.add('app-loading'); // Start fading out body

        const jwt = await createJWT({ sub: userId });

        // Store details
        localStorage.setItem(USER_ID_KEY, userId);
        localStorage.setItem(JWT_KEY, jwt);
        localStorage.setItem(COLOR_KEY, color); // Store selected color

        console.log("JWT generated and details stored for new user.");
        await startMainApp(); // Load main app

      } catch (error) {
        console.error("User selection error:", error);
        // Optionally display an error message
        hideElement('app-loading-indicator'); // Hide loader on error
        showElement('userSelection');
        document.body.classList.remove('app-loading');
      }
    }

    async function startMainApp() {
      console.log("Loading main app scripts...");
      try {
        // Load main app script and cursor party script in parallel
        await Promise.all([
          loadScript('/src/main.tsx', 'module'),
          loadScript('https://cursor-party.armincerf.partykit.dev/cursors.js', 'text/javascript') // Assuming this is plain JS
        ]);
        console.log("Main app scripts loaded.");
        // main.tsx will take over rendering and hiding the loader
      } catch (error) {
        console.error("Failed to load app scripts:", error);
        // Handle script loading errors (e.g., show a persistent error message)
        document.getElementById('app-loading-indicator').innerHTML = `
            <p style="color: var(--error-color); text-align: center;">
                Failed to load application.<br>Please try refreshing the page.
            </p>
        `;
      }
    }

    // --- Global App Control (Called from main.tsx) ---
    window.appReady = () => {
      console.log("App signaling ready. Hiding loader, showing root.");
      hideElement('app-loading-indicator');
      showElement('root');
      document.body.classList.remove('app-loading'); // Ensure body is visible

      // Clean up user selection styles after a brief delay for transition
      setTimeout(() => {
        const styleElement = document.getElementById('user-selection-styles');
        if (styleElement) {
          styleElement.remove();
          console.log("User selection styles removed.");
        }
        document.body.style.overflow = ''; // Restore scrolling
      }, 100); // Small delay allows fade-in of app content
    };

    window.appError = (message) => {
      console.error("App signaling error:", message);
      const loader = document.getElementById('app-loading-indicator');
      if (loader) {
        loader.innerHTML = `<p style="color: var(--error-color); text-align: center;">${message || 'An error occurred.'}</p>`;
        showElement('app-loading-indicator'); // Ensure loader is visible for error
      }
      hideElement('root'); // Hide potentially broken app
      document.body.classList.remove('app-loading'); // Make sure body isn't faded
    }


    // --- Initialization ---
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>

</html>