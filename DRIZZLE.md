# Drizzle ORM Integration

This project uses [Drizzle ORM](https://orm.drizzle.team) for database schema management and querying, and [drizzle-zero](https://github.com/drizzle-team/drizzle-zero) to convert Drizzle schemas to Zero schemas.

## Project Structure

```
ðŸ“¦ suggestion-box
 â”œ ðŸ“‚ drizzle            # Migration files generated by Drizzle
 â”œ ðŸ“‚ scripts            # Utility scripts for database operations
 â”‚   â”œ ðŸ“œ db-setup.ts    # Database setup and seeding script 
 â”‚   â”œ ðŸ“œ test-drizzle.ts # Testing script for Drizzle ORM
 â”‚   â”” ðŸ“œ test-nested-comments.ts # Testing script for nested comments functionality
 â”œ ðŸ“‚ src
 â”‚   â”œ ðŸ“‚ db             # Database-related code
 â”‚   â”‚  â”œ ðŸ“œ schema.ts   # Drizzle schema definitions
 â”‚   â”‚  â”” ðŸ“œ index.ts    # Database connection setup
 â”‚   â”” ðŸ“œ zero-schema.ts # Zero schema generated from Drizzle schema
 â”œ ðŸ“œ drizzle.config.ts  # Drizzle configuration
```

## Available Scripts

The following scripts are available in `package.json`:

- `db:generate` - Generate SQL migrations using Drizzle Kit
- `db:push` - Push schema changes directly to the database
- `db:seed` - Run the database seeding script with comprehensive sample data
- `db:studio` - Launch Drizzle Studio to view and edit data
- `db:seed` - Reset and seed the database in one command

## Database Schema

The schema is defined in `src/db/schema.ts` using Drizzle's PostgreSQL adapter. The following tables are defined:

- `categories` - Feedback categories (Start, Stop, Continue)
- `suggestions` - User suggestions/feedback
- `comments` - Comments on suggestions (supports nested comments via self-referential relationship)
- `reactions` - Emoji reactions on suggestions or comments
- `users` - User information
- `sessions` - Active feedback sessions

## Seeding Data

The seeding script (`scripts/db-setup.ts`) creates a comprehensive set of interrelated data:

1. **Default Categories**: "Start", "Stop", and "Continue" categories
2. **Users**: 10 sample users with random names, avatars, and colors
3. **Suggestions**: 1-5 suggestions per user with realistic body text
4. **Comments**: Root-level comments on suggestions
5. **Nested Comments**: Replies to comments (creating a comment tree)
6. **Reactions**: Emoji reactions on both suggestions and comments
7. **Sessions**: Sample feedback sessions with multiple participants

You can run the seeding script with:

```bash
npm run db:seed
# Or to reset the database first:
npm run db:reset-and-seed
```

## How It Works

### Database Connection

The database connection is set up in `src/db/index.ts`:

```typescript
import "dotenv/config";
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";
import * as schema from "./schema";

const pool = new Pool({
  connectionString: process.env.ZERO_UPSTREAM_DB,
});

export const db = drizzle(pool, { schema });

export * from "./schema";
```

### Zero Schema Generation

The Zero schema is generated from the Drizzle schema using `drizzle-zero` in `src/zero-schema.ts`:

```typescript
import { createZeroSchema } from "drizzle-zero";
import * as drizzleSchema from "./db/schema";

export const schema = createZeroSchema(drizzleSchema, {
  tables: {
    // Configuration for which tables and fields to include
    // ...
  },
});
```

## Testing Database Functionality

The project includes two testing scripts:

### Basic Drizzle Testing (test-drizzle.ts)

This script verifies:
- Database connectivity
- Basic CRUD operations
- Schema validation
- Relationship querying

Run it with:
```bash
npm run db:test
```

### Nested Comments Testing (test-nested-comments.ts)

This script specifically tests:
- Fetching root-level comments
- Fetching replies to comments
- Building a comment tree from self-referential relationships
- Displaying the hierarchical structure

Run it with:
```bash
npm run db:test:comments
```

## Development Workflow

1. Make schema changes in `src/db/schema.ts`
2. Run `npm run db:generate` to create migration files (or `npm run db:push` to apply directly)
3. Update the Zero schema in `src/zero-schema.ts` if needed
4. Run `npm run db:seed` to seed the database with sample data
5. Run `npm run db:test` and `npm run db:test:comments` to verify functionality
6. Start the development server with `npm run dev`

## Adding New Tables

To add a new table:

1. Define the table in `src/db/schema.ts` using Drizzle's schema definition syntax
2. Add relationships if needed
3. Include the table in the `createZeroSchema` configuration in `src/zero-schema.ts`
4. Run `npm run db:push` to apply the changes to the database
5. Update the seeding script if necessary

## Example Usage

```typescript
import { db } from "./db";
import { suggestions, categories } from "./db/schema";
import { eq } from "drizzle-orm";

// Query all suggestions in the "start" category
const startSuggestions = await db
  .select()
  .from(suggestions)
  .where(eq(suggestions.categoryId, "start"));

// Insert a new suggestion
await db.insert(suggestions).values({
  id: "unique-id",
  body: "Let's start doing weekly retros",
  timestamp: new Date(),
  userId: "user-123",
  categoryId: "start",
});

// Query suggestions with related data
const suggestionsWithData = await db.query.suggestions.findMany({
  with: {
    category: true,
    comments: true,
    reactions: true,
  },
});

// Query comments with their replies (nested comments)
const comments = await db.query.comments.findMany({
  where: (comments, { eq, isNull }) => isNull(comments.parentCommentId),
  with: {
    replies: true // Fetches direct replies to each comment
  }
});
```

## References

- [Drizzle ORM Documentation](https://orm.drizzle.team/docs/overview)
- [drizzle-zero Repository](https://github.com/drizzle-team/drizzle-zero)
- [Zero Documentation](https://zero.dev/docs) 